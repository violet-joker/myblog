# IP与MAC
ip地址：虚拟网络地址

MAC地址：真实物理地址

根据目标IP查询ARP表获取对应的MAC地址，从网卡发出

网卡需要配置IP地址(V4, V6)才可正常联网通信

DHCP 动态分配IP地址

插入网线后自动向外发送DHCP请求，请求为其分配IP地址;
路由器获取DHCP请求后，通过DHCP回复报文将为其分配的IP地址发送回去;
操作系统收到DHCP回包后，将其IP配置到网卡上。
(局域网的IP也是唯一的)

MAC地址由操作系统补齐
ARP协议
先发送ARP广播报文，目标IP机器回复自己的MAC地址，其余设备丢弃报文。
发送端将该MAC地址缓存，再将数据包根据该MAC地址发送到目标机器。

# 交换机与路由器

交换机是什么？与路由器有什么区别？

交换机(二层设备)：
通过网线连接设备，查询MAC地址表{<端口号>, <MAC>地址}；
将发送源MAC与交换机接收端口绑定；
查询出发端口，找到，发送数据；未找到，向所有端口群发。

路由器(多了LAN口和WAN口)：
LAN口，网线连接联网设备(台式机)；
WAN口(网关)，连接因特网(运营商网络)。

子网划分(网关)

不同网络不能直接通信，须有网关转发
在网关上有多个网卡，配置不同的两个子网ip地址，即可通过网关转发
形成了两个子网之间的网络，实现不同子网之间的通信。

发送源发送数据包，首先判断目标地址是否属于子网，
是则网卡直接发出；
否则将目标MAC改为网关MAC发出;
网关拿到数据包，通过路由表查询目标地址对应的网络，
将源MAC改为网关MAC，再由网关网卡发出。

# 家庭网络与因特网

IP 不冲突？ SNAT，DNAT？

如果子网内IP冲突，会导致ARP表混乱，目标不确定,
路由器使数据包发送时编程不同的IP地址。

SNAT(源地址转换技术)

计算机发出数据报，路由器SNAT将源IP修改成WAN下公网IP，
由服务器处理；处理完后需要回复，再将源IP作为目标IP发送回来。

返回的数据包如何区分两台计算机？
还需修改传输层协议，通过协议特定的标记进行关联。

TCP协议：IP地址 + 端口号
UDP协议：IP地址 + 端口号
ICMP协议：IP地址 + type，code
其他协议：IP地址 + 其他标记

DNAT(目标地址转换技术)
公网IP不能直接访问内网地址，DNAT将内网端口配置到目标IP，
再由路由器处理转发给目标计算机。

# TCP与UDP协议

TCP(全双工通信)：
三次握手(建立连接，解决网络信道不可靠问题):
客户端向服务端发送SYN包请求连接；
服务端回复SYN+ACK包同意连接；
客户端收到后回复ACK包确认收到；
连接建立。


传输确认(解决丢包问题、乱序问题等):
建立发送缓冲区，每次发送取一段数据，
发送报文包含序列号，长度，数据内容；
接收端收到后回复ACK包确认，ACK = 序列号 + 长度 = 下一包数据的起始序列号；
可以切割发送，根据序列号和长度重组，若检验发现丢失，可要求重写发送。

四次挥手(关闭连接):
第一次挥手：
客户端发送FIN包，进入终止等待状态1；
第二次挥手：
服务端发送ACK包，进入关闭等待状态，客户端接收后进入终止等待状态2；
第三次握手：
服务端发送FIN包，进入最终确认状态；
第四次挥手：
客户端回复ACK包，进入超时等待状态，超时后关闭连接。
服务端收到ACK包后关闭连接。
超时等待防止服务端未收到ACK包，等待可以处理服务端重传的FIN包，
重新发送ACK包，并刷新超时等待时间。


UDP：
将数据包直接从网卡发送。
性能损耗少，资源占用少，稳定性弱（可能丢包）


# VPN

# DHCP协议

操作系统使用UDP协议广播DHCP Discover报文寻找DHCP服务器(路由器)，
服务器从自己的IP池中选取空闲IP包装成DHCP offer包回复给PC；
PC接收包后，决定是否使用该IP(广播发送的请求，可能收到多个路由器
的回复包，一般选择第一个)；
选择好IP后再广播发送DHCP request包，表明自己选中的IP；
服务器回复ACK包确认此IP可用。

当PC重启后，只需广播发送DHCP Request包再次确认即可。

# ARP协议

通过IP地址查询MAC地址的协议

源PC广播发送报文，目标IP与自己一致的接收端单播发送ARP包，源PC接收
后将目标MAC地址缓存到ARP表
当主机更换IP时，免费广播发送ARP数据包，接收端自行更新ARP表即可。

ARP攻击：
伪造虚假IP，发送免费ARP报文，让其他PC误以为交换机的IP与MAC映射修改了，
更新ARP表，从而将本应发送给交换机的数据包发送到诈骗PC端。

# ICMP协议

互联网控制消息协议

检测网络中发现的各种问题。

查询报告 ping

差错报告 traceroute

# DNS协议

将输入的网址解析获取域名，组建成一包DNS查询报文，发送到主机
上一级DNS服务器，DHS通过DHCP协议自动获取。
服务器在自己缓存的DNS池中查询域名对应的IP地址；若找不到则向
更上一级的DNS服务器进行查找。

